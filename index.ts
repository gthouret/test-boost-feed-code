import { interval, fromEvent, merge, empty,  BehaviorSubject, Observable } from 'rxjs';
import { switchMap, scan, takeWhile, startWith, mapTo, tap, filter, first, mergeMap, skip, take, map } from 'rxjs/operators';
import { FeedsService } from './feeds.service';
import { EntitiesService } from './entities.service';
import { BlockListService } from './block-list.service';

const response = {"status":"success","entities":[{"guid":"998658487246393350","owner_guid":"991463054707265537","timestamp":1563474737843,"urn":"urn:boost:newsfeed:998658487246393350","entity":{"guid":"997977115791986695","type":"activity","time_created":"1563312285","time_updated":"1563312285","container_guid":"991463054707265537","owner_guid":"991463054707265537","access_id":"2","tags":[],"nsfw":[1,2],"nsfw_lock":[],"allow_comments":true,"title":false,"blurb":false,"perma_url":false,"message":"@bhayward","ownerObj":{"guid":"991463054707265537","type":"user","subtype":false,"time_created":"1561759212","time_updated":false,"container_guid":"0","owner_guid":"0","site_guid":false,"access_id":"2","tags":[],"nsfw":[1,2],"nsfw_lock":[],"name":"nemofin","username":"nemofin","language":"en","icontime":"1562424356","legacy_guid":false,"featured_id":false,"banned":"no","ban_reason":false,"website":"","briefdescription":"","dob":"","gender":"","city":"","merchant":false,"boostProPlus":false,"fb":false,"mature":0,"monetized":"","signup_method":false,"social_profiles":[],"feature_flags":false,"programs":[],"plus":false,"hashtags":false,"verified":false,"founder":false,"disabled_boost":false,"boost_autorotate":true,"categories":[],"wire_rewards":null,"pinned_posts":[],"is_mature":false,"mature_lock":false,"last_accepted_tos":1,"opted_in_hashtags":0,"last_avatar_upload":"1562424356","canary":false,"theme":false,"toaster_notifications":true,"chat":true,"subscribed":false,"subscriber":false,"boost_rating":1,"rewards":false,"p2p_media_enabled":false,"is_admin":false,"onchain_booster":0,"eth_wallet":"","rating":1},"containerObj":false,"thumbnail_src":false,"remind_object":false,"entity_guid":false,"featured":false,"featured_guid":false,"custom_type":false,"custom_data":false,"thumbs:up:count":0,"thumbs:up:user_guids":[],"thumbs:down:count":0,"thumbs:down:user_guids":false,"p2p_boosted":false,"mature":false,"monetized":false,"paywall":"","edited":"","comments_enabled":true,"wire_totals":{"tokens":"0"},"boost_rejection_reason":-1,"pending":"","rating":2,"ephemeral":false,"hide_impressions":false,"pinned":false,"comments:count":3,"urn":"urn:boost:newsfeed:998658487246393350","boosted":true,"boosted_guid":"998658487246393350","boosted_onchain":false,"impressions":668,"reminds":0,"wire_threshold":null,"time_sent":null,"thumbnails":[]}},{"guid":"998658547002642441","owner_guid":"991463054707265537","timestamp":1563474751968,"urn":"urn:boost:newsfeed:998658547002642441","entity":{"guid":"995475753279688713","type":"activity","time_created":"1562715914","time_updated":"1562715914","container_guid":"991463054707265537","owner_guid":"991463054707265537","access_id":"2","nsfw":[1,2],"nsfw_lock":[],"allow_comments":true,"title":false,"blurb":false,"perma_url":false,"message":"#1 #2 #3 #4 #5 #6","ownerObj":{"guid":"991463054707265537","type":"user","subtype":false,"time_created":"1561759212","time_updated":false,"container_guid":"0","owner_guid":"0","site_guid":false,"access_id":"2","tags":[],"nsfw":[1,2],"nsfw_lock":[],"name":"nemofin","username":"nemofin","language":"en","icontime":"1562424356","legacy_guid":false,"featured_id":false,"banned":"no","ban_reason":false,"website":"","briefdescription":"","dob":"","gender":"","city":"","merchant":false,"boostProPlus":false,"fb":false,"mature":0,"monetized":"","signup_method":false,"social_profiles":[],"feature_flags":false,"programs":[],"plus":false,"hashtags":false,"verified":false,"founder":false,"disabled_boost":false,"boost_autorotate":true,"categories":[],"wire_rewards":null,"pinned_posts":[],"is_mature":false,"mature_lock":false,"last_accepted_tos":1,"opted_in_hashtags":0,"last_avatar_upload":"1562424356","canary":false,"theme":false,"subscribed":false,"subscriber":false,"boost_rating":1,"rewards":false,"p2p_media_enabled":false,"is_admin":false,"onchain_booster":0,"eth_wallet":"","rating":1},"containerObj":false,"thumbnail_src":false,"remind_object":{"guid":"993851923524227086","type":"activity","time_created":"1562328762","time_updated":"1562328762","container_guid":"991463054707265537","owner_guid":"991463054707265537","access_id":"2","tags":[],"nsfw":[1,2],"nsfw_lock":[],"title":false,"blurb":false,"perma_url":false,"message":"hello","ownerObj":{"guid":"991463054707265537","type":"user","subtype":false,"time_created":"1561759212","time_updated":false,"container_guid":"0","owner_guid":"0","site_guid":false,"access_id":"2","tags":[],"nsfw":["1","2"],"nsfw_lock":[],"name":"nemofin","username":"nemofin","language":"en","icontime":"1562328663","legacy_guid":false,"featured_id":false,"banned":"no","ban_reason":false,"website":"","briefdescription":"","dob":"","gender":"","city":"","merchant":false,"boostProPlus":false,"fb":false,"mature":"0","monetized":"","signup_method":false,"social_profiles":[],"feature_flags":false,"programs":[],"plus":false,"hashtags":false,"verified":false,"founder":false,"disabled_boost":false,"boost_autorotate":true,"categories":[],"wire_rewards":null,"pinned_posts":[],"is_mature":false,"mature_lock":false,"last_accepted_tos":"1","opted_in_hashtags":"0","last_avatar_upload":"1562092522","canary":false,"theme":false,"subscribed":false,"subscriber":false,"boost_rating":"1","rewards":false,"p2p_media_enabled":false,"is_admin":false,"onchain_booster":"0","eth_wallet":"","rating":"1"},"containerObj":false,"thumbnail_src":false,"remind_object":false,"entity_guid":false,"featured":false,"featured_guid":false,"custom_type":false,"custom_data":false,"thumbs:up:count":"0","thumbs:up:user_guids":[],"thumbs:down:count":"0","thumbs:down:user_guids":false,"p2p_boosted":false,"mature":false,"monetized":false,"paywall":"","edited":"","comments_enabled":true,"wire_totals":{"tokens":"0"},"boost_rejection_reason":"-1","pending":"","rating":"2","ephemeral":false,"hide_impressions":false,"comments:count":"0","impressions":"4","reminds":"0","wire_threshold":null},"entity_guid":false,"featured":false,"featured_guid":false,"custom_type":false,"custom_data":false,"thumbs:up:count":0,"thumbs:up:user_guids":[],"thumbs:down:count":0,"thumbs:down:user_guids":false,"p2p_boosted":false,"mature":false,"monetized":false,"paywall":"","edited":"","comments_enabled":true,"wire_totals":{"tokens":"0"},"boost_rejection_reason":-1,"pending":"","rating":2,"ephemeral":false,"hide_impressions":false,"pinned":false,"comments:count":0,"urn":"urn:boost:newsfeed:998658547002642441","boosted":true,"boosted_guid":"998658547002642441","boosted_onchain":false,"impressions":483,"reminds":1,"wire_threshold":null,"time_sent":null,"thumbnails":[]}},{"guid":"998658642007822356","owner_guid":"991463054707265537","timestamp":1563474774626,"urn":"urn:boost:newsfeed:998658642007822356","entity":{"guid":"995475655103614989","type":"activity","time_created":"1562715890","time_updated":"1562715891","container_guid":"991463054707265537","owner_guid":"991463054707265537","access_id":"2","nsfw":[1,2],"nsfw_lock":[],"allow_comments":true,"title":false,"blurb":false,"perma_url":false,"message":"#1 #2 #3 #4 #5 #6","ownerObj":{"guid":"991463054707265537","type":"user","subtype":false,"time_created":"1561759212","time_updated":false,"container_guid":"0","owner_guid":"0","site_guid":false,"access_id":"2","tags":[],"nsfw":[1,2],"nsfw_lock":[],"name":"nemofin","username":"nemofin","language":"en","icontime":"1562424356","legacy_guid":false,"featured_id":false,"banned":"no","ban_reason":false,"website":"","briefdescription":"","dob":"","gender":"","city":"","merchant":false,"boostProPlus":false,"fb":false,"mature":0,"monetized":"","signup_method":false,"social_profiles":[],"feature_flags":false,"programs":[],"plus":false,"hashtags":false,"verified":false,"founder":false,"disabled_boost":false,"boost_autorotate":true,"categories":[],"wire_rewards":null,"pinned_posts":[],"is_mature":false,"mature_lock":false,"last_accepted_tos":1,"opted_in_hashtags":0,"last_avatar_upload":"1562424356","canary":false,"theme":false,"subscribed":false,"subscriber":false,"boost_rating":1,"rewards":false,"p2p_media_enabled":false,"is_admin":false,"onchain_booster":0,"eth_wallet":"","rating":1},"containerObj":false,"thumbnail_src":false,"remind_object":{"guid":"994253285235888136","type":"activity","time_created":"1562424454","time_updated":"1562715846","container_guid":"994252987062816776","owner_guid":"991463054707265537","access_id":"994252987062816776","tags":[],"nsfw":[1,2],"nsfw_lock":[],"title":"","blurb":false,"perma_url":false,"message":"hi #1 #2 #3 #4 #5","ownerObj":{"guid":"991463054707265537","type":"user","subtype":false,"time_created":"1561759212","time_updated":false,"container_guid":"0","owner_guid":"0","site_guid":false,"access_id":"2","tags":[],"nsfw":["1","2"],"nsfw_lock":[],"name":"nemofin","username":"nemofin","language":"en","icontime":"1562424356","legacy_guid":false,"featured_id":false,"banned":"no","ban_reason":false,"website":"","briefdescription":"","dob":"","gender":"","city":"","merchant":false,"boostProPlus":false,"fb":false,"mature":"0","monetized":"","signup_method":false,"social_profiles":[],"feature_flags":false,"programs":[],"plus":false,"hashtags":false,"verified":false,"founder":false,"disabled_boost":false,"boost_autorotate":true,"categories":[],"wire_rewards":null,"pinned_posts":[],"is_mature":false,"mature_lock":false,"last_accepted_tos":"1","opted_in_hashtags":"0","last_avatar_upload":"1562424356","canary":false,"theme":false,"subscribed":false,"subscriber":false,"boost_rating":"1","rewards":false,"p2p_media_enabled":false,"is_admin":false,"onchain_booster":"0","eth_wallet":"","rating":"1"},"containerObj":{"guid":"994252987062816776","type":"group","name":"ASDASDA","brief_description":null,"icon_time":null,"banner":"1562424389","banner_position":"0","membership":"2","moderated":"0","default_view":"0","featured":"0","featured_id":null,"tags":[],"boost_rejection_reason":"-1","mature":false,"rating":"1","videoChatDisabled":"0","pinned_posts":[],"owner_guid":"991463054707265537","members:count":"1","requests:count":"0","icontime":null,"briefdescription":null,"nsfw":[],"nsfw_lock":[],"is:owner":true,"is:moderator":false,"is:member":true,"is:creator":true,"is:awaiting":false,"comments:count":"0"},"thumbnail_src":false,"remind_object":false,"entity_guid":false,"featured":false,"featured_guid":false,"custom_type":false,"custom_data":false,"thumbs:up:count":"0","thumbs:up:user_guids":[],"thumbs:down:count":"0","thumbs:down:user_guids":false,"p2p_boosted":false,"mature":false,"monetized":false,"paywall":"","edited":"1","comments_enabled":true,"wire_totals":{"tokens":"0"},"boost_rejection_reason":"-1","pending":"","rating":"2","ephemeral":false,"hide_impressions":false,"comments:count":"0","impressions":"13","reminds":"0","wire_threshold":null},"entity_guid":false,"featured":false,"featured_guid":false,"custom_type":false,"custom_data":false,"thumbs:up:count":0,"thumbs:up:user_guids":[],"thumbs:down:count":0,"thumbs:down:user_guids":false,"p2p_boosted":false,"mature":false,"monetized":false,"paywall":"","edited":"","comments_enabled":true,"wire_totals":{"tokens":"0"},"boost_rejection_reason":-1,"pending":"","rating":2,"ephemeral":false,"hide_impressions":false,"pinned":false,"comments:count":0,"urn":"urn:boost:newsfeed:998658642007822356","boosted":true,"boosted_guid":"998658642007822356","boosted_onchain":false,"impressions":464,"reminds":2,"wire_threshold":null,"time_sent":null,"thumbnails":[]}},{"guid":"998673838793297939","owner_guid":"997650977647497234","timestamp":1563478397763,"urn":"urn:boost:newsfeed:998673838793297939","entity":{"guid":"998673704206471187","type":"activity","time_created":"1563478365","time_updated":"1563478365","container_guid":"997650977647497234","owner_guid":"997650977647497234","access_id":"2","tags":[],"nsfw":[],"nsfw_lock":[],"allow_comments":true,"title":false,"blurb":false,"perma_url":false,"message":"Dos","ownerObj":{"guid":"997650977647497234","type":"user","subtype":false,"time_created":"1563234528","time_updated":false,"container_guid":"0","owner_guid":"0","site_guid":false,"access_id":"2","tags":[],"nsfw":[],"nsfw_lock":[],"name":"brianhatchet2","username":"brianhatchet2","language":"en","icontime":"1563234528","legacy_guid":false,"featured_id":false,"banned":"no","ban_reason":false,"website":false,"briefdescription":"","dob":false,"gender":false,"city":false,"merchant":false,"boostProPlus":false,"fb":false,"mature":0,"monetized":false,"signup_method":false,"social_profiles":[],"feature_flags":false,"programs":[],"plus":false,"hashtags":false,"verified":false,"founder":false,"disabled_boost":false,"boost_autorotate":true,"categories":[],"wire_rewards":null,"pinned_posts":[],"is_mature":false,"mature_lock":false,"last_accepted_tos":1,"opted_in_hashtags":0,"last_avatar_upload":"0","canary":false,"theme":false,"subscribed":false,"subscriber":false,"boost_rating":1,"rewards":false,"p2p_media_enabled":false,"is_admin":false,"onchain_booster":0,"eth_wallet":"","rating":1},"containerObj":false,"thumbnail_src":false,"remind_object":false,"entity_guid":false,"featured":false,"featured_guid":false,"custom_type":false,"custom_data":false,"thumbs:up:count":0,"thumbs:up:user_guids":[],"thumbs:down:count":0,"thumbs:down:user_guids":false,"p2p_boosted":false,"mature":false,"monetized":false,"paywall":"","edited":"","comments_enabled":true,"wire_totals":{"tokens":"0"},"boost_rejection_reason":-1,"pending":"","rating":2,"ephemeral":false,"hide_impressions":false,"pinned":false,"comments:count":1,"urn":"urn:boost:newsfeed:998673838793297939","boosted":true,"boosted_guid":"998673838793297939","boosted_onchain":false,"impressions":541,"reminds":0,"wire_threshold":null,"time_sent":null,"thumbnails":[]}},{"guid":"998673941574717446","owner_guid":"997650977647497234","timestamp":1563478422266,"urn":"urn:boost:newsfeed:998673941574717446","entity":{"guid":"998673894200053775","type":"activity","time_created":"1563478410","time_updated":"1563478410","container_guid":"997650977647497234","owner_guid":"997650977647497234","access_id":"2","tags":[],"nsfw":[],"nsfw_lock":[],"allow_comments":true,"title":false,"blurb":false,"perma_url":false,"message":"Tres","ownerObj":{"guid":"997650977647497234","type":"user","subtype":false,"time_created":"1563234528","time_updated":false,"container_guid":"0","owner_guid":"0","site_guid":false,"access_id":"2","tags":[],"nsfw":[],"nsfw_lock":[],"name":"brianhatchet2","username":"brianhatchet2","language":"en","icontime":"1563234528","legacy_guid":false,"featured_id":false,"banned":"no","ban_reason":false,"website":false,"briefdescription":"","dob":false,"gender":false,"city":false,"merchant":false,"boostProPlus":false,"fb":false,"mature":0,"monetized":false,"signup_method":false,"social_profiles":[],"feature_flags":false,"programs":[],"plus":false,"hashtags":false,"verified":false,"founder":false,"disabled_boost":false,"boost_autorotate":true,"categories":[],"wire_rewards":null,"pinned_posts":[],"is_mature":false,"mature_lock":false,"last_accepted_tos":1,"opted_in_hashtags":0,"last_avatar_upload":"0","canary":false,"theme":false,"subscribed":false,"subscriber":false,"boost_rating":1,"rewards":false,"p2p_media_enabled":false,"is_admin":false,"onchain_booster":0,"eth_wallet":"","rating":1},"containerObj":false,"thumbnail_src":false,"remind_object":false,"entity_guid":false,"featured":false,"featured_guid":false,"custom_type":false,"custom_data":false,"thumbs:up:count":1,"thumbs:up:user_guids":["1004007168413798413"],"thumbs:down:count":0,"thumbs:down:user_guids":false,"p2p_boosted":false,"mature":false,"monetized":false,"paywall":"","edited":"","comments_enabled":true,"wire_totals":{"tokens":"0"},"boost_rejection_reason":-1,"pending":"","rating":2,"ephemeral":false,"hide_impressions":false,"pinned":false,"comments:count":1,"urn":"urn:boost:newsfeed:998673941574717446","boosted":true,"boosted_guid":"998673941574717446","boosted_onchain":false,"impressions":635,"reminds":0,"wire_threshold":null,"time_sent":null,"thumbnails":[]}}],"load-next":"1566323023999"};

let blocklistService = new BlockListService();
let entitiesService = new EntitiesService(blocklistService);
let feedsService = new FeedsService(entitiesService, blocklistService);

let offset = 0;

const guidLabel = document.getElementById('guid');
const offsetLabel = document.getElementById('offset');
const nextButton = document.getElementById('next');
const resetButton = document.getElementById('reset');

feedsService
  .setLimit(12)
  .setOffset(0)
  .setEndpoint('api/v2/boost/feed')
  .fetch(response);

async function fetch() {
    if (offset++ >= (feedsService.rawFeed.getValue().length -1)) {
      offset = 0;
    }
    // Refetch every 2 calls, if not loading
    if (offset % 2 && !feedsService.inProgress.getValue()) {
      feedsService.clear();
      feedsService.fetch(response);
    }
    console.log('offset: ' + offset);
    return await feedsService.feed
      .pipe(
        filter(item => item.length > 0),
        first(),
        mergeMap(feed => feed),
        skip(offset),
        take(1),
        switchMap(async entity => {
          if (!entity) {
            return false;
          }
          return await entity.pipe(first()).toPromise();
        })
      )
      .toPromise();
  }

nextButton.onclick = function(event) {
  offsetLabel.innerHTML = offset.toString();
  fetchAndUpdate();
};

async function fetchAndUpdate() {
  let entity = await fetch();
  if (entity === false) {
    guidLabel.innerHTML = 'nope';
  } else {
    console.log(entity);
    guidLabel.innerHTML = entity.guid;
  }
}